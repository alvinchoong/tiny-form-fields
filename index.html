<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- https://github.com/jinjor/elm-break-dom -->
  <meta name="google" content="notranslate">
  <meta name="darkreader-lock">
  <!--  -->

  <title>Embed</title>
  <link rel="stylesheet" href="./dist/tiny-form-fields.min.css">
</head>

<body class="bg-gray-200">
  <!-- (Optional) Introduce a `validated-input` custom field -->
  <script type="module">
    import { BaseCustomField } from './dist/base-custom-field.js';

    class ValidatedInput extends BaseCustomField {
      constructor() {
        super();
      }

      validate() {
        // First, clear any previous custom validity message
        super.validate();

        const value = this.input.value;
        let validityMessage = '';

        // Custom validation logic
        if (value.length !== 9 && value !== '') {
          validityMessage = 'Input must be exactly 9 characters long.';
        }

        // Set custom validity on the internal input
        this.input.setCustomValidity(validityMessage);
      }
    }

    customElements.define('validated-input', ValidatedInput);
  </script>

  <!--
        Bring your own <form> to submit to the server; tiny-form-fields don't deal with it for you.
        In "Editor" or "Preview" mode, form submit will carry a `tiny-form-fields` form field
        containing the JSON representation of the form fields. Save that JSON on your server.

        In "CollectData" mode, pass the json through flags.formFields and the form fields will be rendered.
        When the form is submitted, all the form field values will be included in the form post.
    -->
  <form class="min-h-screen" method="post" action="https://httpbin.org/post">
    <div class="p-1 md:p-3 md:w-11/12 my-8 ml-auto mr-auto bg-white min-h-full shadow">
      <!-- tiny-form-fields render here -->
      <div id="tiny-form-fields"></div>
      <!-- end render -->
    </div>
    <div class="p-1 md:p-3 md:w-11/12 my-8 ml-auto mr-auto bg-white min-h-full shadow">
      <div class="mb-4" id="editor-mode-buttons">
        <a tabindex="0" id="reset-form" href="?"
          class="inline-block bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 mr-2 mb-2 rounded text-sm leading-4 float-left">
          Reset
        </a>
        <div class="float-right">
          <button type="submit" tabindex="0"
            class="inline-block bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 mr-2 mb-2 rounded text-sm leading-4">
            Submit form config
          </button>
          <a tabindex="0" id="view-sample-collect-data" href="#" target="_blank"
            class="inline-block bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 mr-2 mb-2 rounded text-sm leading-4 hidden">
            View form
          </a>
        </div>
        <div class="clear-both"></div>
      </div>
      <div class="mb-4 hidden" id="collect-mode-buttons">
        <button type="reset" tabindex="0"
          class="inline-block bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 mr-2 mb-2 rounded text-sm leading-4 float-left">
          Reset
        </button>
        <div class="float-right">
          <button type="submit" tabindex="0"
            class="inline-block bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 mr-2 mb-2 rounded text-sm leading-4">
            Submit
          </button>
        </div>
        <div class="clear-both"></div>
      </div>
      <div class="text-right">
        <a class="text-xs text-gray-500" target="_blank"
          href="https://github.com/choonkeat/tiny-form-fields">github.com/choonkeat/tiny-form-fields</a>
      </div>
    </div>
  </form>

  <!-- Include this script after your <form> -->
  <script type="module">
    import { Elm } from './dist/tiny-form-fields.esm.js';

    let hash = (window.location.hash.substring(1) || "").split("&").reduce((acc, item) => {
      let [key, value] = item.split("=")
      acc[key] = value
      return acc
    }, {})
    hash['viewMode'] = hash['viewMode'] || "Editor" // "Editor" for form admins, "CollectData" for form users

    // Show/hide buttons based on viewMode
    const editorButtons = document.getElementById('editor-mode-buttons');
    const collectButtons = document.getElementById('collect-mode-buttons');
    if (hash['viewMode'] === 'Editor') {
      editorButtons.classList.remove('hidden');
      collectButtons.classList.add('hidden');
    } else {
      editorButtons.classList.add('hidden');
      collectButtons.classList.remove('hidden');
    }

    const flags = {
      viewMode: hash['viewMode'],
      formFields: hash['formFields'] ? JSON.parse(decodeURIComponent(hash['formFields'])) : null, // JSON representation of form fields
      formValues: { "Email": "email@example.com", "ChooseOne": "No", "ChooseMany": ["Durian", "Banana"] }, // pre-fill form fields
      shortTextTypeList: [
        {
          // optional: you can add custom fields using webcomponents
          "Custom Element": {
            "inputTag": "validated-input",
            "attributes": {
              "type": "url"
            }
          }
        },
        {
          "Email": {
            "type": "email"
          }
        },
        {
          "Emails": {
            "type": "email",
            "multiple": "true"
          }
        },
        {
          "Telephone": {
            "type": "tel"
          }
        },
        {
          "URL": {
            "type": "url"
          }
        },
        {
          "Color": {
            "type": "color"
          }
        },
        {
          "Date": {
            "type": "date"
          }
        },
        {
          "Time": {
            "type": "time"
          }
        },
        {
          "Date & Time": {
            "type": "datetime-local"
          }
        }
      ],
    }

    // code to setup tiny-form-fields
    let app = Elm.Main.init(
      {
        node: document.getElementById('tiny-form-fields'),
        flags: flags,
      }
    )
    app.ports.outgoing.subscribe((event) => {
      try {
        // do what you need with the JSON here
        // e.g. we update one of our a[href]
        switch (event.type) {
          case 'formFields':
            let formFields = event.formFields;
            console.log('formFields', JSON.stringify(formFields, null, 2));
            const newHash = `viewMode=${hash['viewMode']}&formFields=${encodeURIComponent(JSON.stringify(formFields))}`
            setTimeout(function () { window.location.hash = newHash; }, 0);
            if (hash['viewMode'] === "CollectData") return

            let ele = document.getElementById('view-sample-collect-data');
            ele.href = `?#viewMode=CollectData&formFields=${encodeURIComponent(JSON.stringify(formFields))}`;
            if (formFields && formFields.length > 0) {
              ele.classList.remove('hidden');
              document.getElementById('reset-form').classList.remove('hidden');
            } else {
              ele.classList.add('hidden');
            }
            break;
          case 'formValues':
            console.log('formValues', JSON.stringify(event.formValues, null, 2));
            break;
          default:
            console.log('unknown outgoing port', event);
        }
      } catch (e) {
        console.error('error', e);
      }
    })
  </script>
</body>

</html>